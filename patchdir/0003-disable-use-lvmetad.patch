From 3a466b7ee0651b11465b4f5436093c929001626c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fabian=20Gr=C3=BCnbichler?= <f.gruenbichler@proxmox.com>
Date: Mon, 9 Oct 2017 12:34:14 +0200
Subject: [PATCH 3/6] disable-use-lvmetad
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

see https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=826570

Signed-off-by: Fabian Gr√ºnbichler <f.gruenbichler@proxmox.com>
---
 debian/lvm2.postinst | 11 +++++++++++
 debian/rules         |  3 ++-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/debian/lvm2.postinst b/debian/lvm2.postinst
index 563162c..5f69d38 100644
--- a/debian/lvm2.postinst
+++ b/debian/lvm2.postinst
@@ -20,4 +20,15 @@ esac
 
 #DEBHELPER#
 
+case "$1" in
+    configure)
+        # disable unless lvm config says otherwise
+        use_lvmetad="$(lvmconfig --type default global/use_lvmetad)"
+        if [ "$use_lvmetad" = "use_lvmetad=0" ]; then
+            echo "Stopping lvmetad, '$use_lvmetad' is set"
+            systemctl stop lvm2-lvmetad.service
+        fi
+    ;;
+esac
+
 exit 0
diff --git a/debian/rules b/debian/rules
index f4e16c4..eaafe6c 100755
--- a/debian/rules
+++ b/debian/rules
@@ -92,6 +92,7 @@ $(STAMPS_DIR)/setup_deb: $(STAMPS_DIR)/source
 		--enable-cmirrord \
 		--enable-dmeventd \
 		--enable-lvmetad \
+		--disable-use-lvmetad \
 		--enable-lvmpolld \
 		--enable-pkgconfig \
 		--enable-readline \
@@ -280,9 +281,9 @@ install_lvm2: $(STAMPS_DIR)/install_deb install_libdevmapper install_liblvm2
 	dh_installinit --restart-after-upgrade --name lvm2-lvmpolld
 	dh_systemd_enable \
 		lvm2-monitor.service \
-		lvm2-lvmetad.socket \
 		lvm2-lvmpolld.socket
 	dh_systemd_enable --no-enable \
+		lvm2-lvmetad.socket \
 		lvm2-lvmetad.service \
 		lvm2-lvmpolld.service
 	dh_systemd_start --restart-after-upgrade \
-- 
2.14.1

